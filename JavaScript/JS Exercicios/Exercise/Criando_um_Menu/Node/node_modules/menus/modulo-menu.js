const prompt = require('prompt-sync')();

const {verificaOpcao} = require('./leiaInteiro');

const {lerArquivo, criarArquivo, escreverArquivo} = require('../menus/lerArquivo');

function linha(vezes=35) {

    console.log('-'.repeat(vezes));
}

function menuPrincipal(msg) {

    let nomeDoArquivo = '/home/dev/Documents/MyAllLearningPath/JavaScript/JS Exercicios/Exercise/Criando_um_Menu/Node/cursoemvideo.json';

    try {
        
        criarArquivo(nomeDoArquivo, lerArquivo(nomeDoArquivo)[0]);

        while (true) {

            linha();

            console.log('         MENU PRINCIPAL');

            linha();

            console.log('\u001b[33m1 -\u001b[m \u001b[94mVer pessoas cadastradas\u001b[m\n\u001b[33m2 -\u001b[m \u001b[94mCadastrar nova Pessoa\u001b[m\n\u001b[33m3 -\u001b[m \u001b[94mSair do Sistema\u001b[m');

            linha();

            let opcaoUser = prompt(msg);

            let eValido = verificaOpcao(opcaoUser, 3);

            while (eValido) {

                console.error('ERRO: Por favor, digite um número inteiro válido. Ou Digite um opção válida.');

                opcaoUser = prompt(msg);

                eValido = verificaOpcao(opcaoUser, 3);
            }

            switch (opcaoUser) {

                case '1': 

                    linha();

                    console.log('       PESSOAS CADASTRADAS')

                    linha();

                    try {

                        let p = JSON.parse(lerArquivo(nomeDoArquivo)[1]);

                        for (let pessoa in p) {
    
                            console.log(p[`${pessoa}`].primeiro_nome, p[pessoa].segundo_nome + `         ${p[pessoa].idade} anos`);
                        }
    
                        break;
                    
                    } catch (erro) {

                        console.error('O Banco de Dados está vazio', erro);

                        return 0;
                    }

                case '2':

                    linha();

                    console.log('         NOVO CADASTRO')

                    linha();

                    try {

                        let nomeUser = prompt('Digite o nome da nova pessoa: ');
    
                        let sobrenomeUser = prompt('Digite o sobrenome da nova pessoa: ');

                        let idadeUser = Number(prompt('Digite a idade da nova pessoa: '));

                        let novoCadastro;

                        if (lerArquivo(nomeDoArquivo)[1] == '') {
    
                            novoCadastro = `{"${nomeUser}":{"primeiro_nome":"${nomeUser}", "segundo_nome":"${sobrenomeUser}", "idade":${idadeUser} }}`;

                            escreverArquivo(nomeDoArquivo, novoCadastro);

                            linha();
    
                            console.log(`\u001b[92mUsuário cadastrado com sucesso!\u001b[m`); 

                            break;
                        
                        } else {

                            novoCadastro = JSON.parse(lerArquivo(nomeDoArquivo)[1]);
    
                            novoCadastro[`${nomeUser}`] = { primeiro_nome: `${nomeUser}`, segundo_nome: `${sobrenomeUser}`, idade: `${idadeUser}` }
        
                            escreverArquivo(nomeDoArquivo, JSON.stringify(novoCadastro));
    
                            linha();
    
                            console.log(`\u001b[92mUsuário cadastrado com sucesso!\u001b[m`); 
    
                            break;
                        }

                    } catch (erro) {

                        console.error("Usuário não foi cadastrado com sucesso.", erro);

                        return 0;
                    }
            }

            if (opcaoUser == '3') {

                linha();

                console.log('  Saindo do Sistema... Até logo!')

                linha();

                break;
            }
    }

    } catch (error) {

        console.info('O usuário decidiu não continuar com o programa. Saindo...', error);
    }
}

module.exports = {menuPrincipal};